pico-8 cartridge // http://www.pico-8.com
version 32
__lua__
function _init()
	t=0

	ship = {
	sp=1,
	x=60,
	y=60,
	hp=3,
	t=0,
	p=0,
	hit = false}
	ship.box={x1=0,y1=0,x2=7,y2=7}

	bullets={}
	enemies={}
	explosions={}
	
	for i=1,10 do
		add(enemies,{ 
			sp=17,
			m_x=i*16,
			m_y=40-i*2,
			x=-32,
			y=-32,
			r=12,
			box={x1=0,y1=0,x2=7,y2=7},
			t=0,
			hit=false
		})
	end
	start_game()
end

function hitbox(s)
	local box={}
	box.x1 = s.x + s.box.x1
	box.y1 = s.y + s.box.y1
	box.x2 = s.x + s.box.x2
	box.y2 = s.y + s.box.y2

	return box
end

function coll(a,b)
	local box_a=hitbox(a)
	local box_b=hitbox(b)
	
	if box_a.x1 > box_b.x2 or
				box_a.y1 > box_b.y2 or
				box_b.x1 > box_a.x2 or
				box_b.y1 > box_a.y2 then 
				return false
 end
 return true
end

function explode(x,y)
	add(explosions, {x=x, y=y, t=0})
	sfx(1)

end

function fire()
	local b={
		sp=3,
		x=ship.x,
		y=ship.y,
		dx=0,
		dy=-3,
		box={x1=4,y1=2,x2=4,y2=5}		
	}		
	add(bullets,b)
	sfx(0)
end

function start_game()
	_update=update_game
	_draw=draw_game
end

function game_over()
	_update =update_over
	_draw=draw_over
end

function update_game()
	t=t+1
	
	if ship.hit then
		ship.t += 1
		if ship.t > 30 then
			ship.hit = false
			ship.t = 0
		end
	end
	
	if(t%6<3) then
		ship.sp=1
	else
		ship.sp=2
	end
	
	for b in all(bullets) do
	 b.x+=b.dx
	 b.y+=b.dy
	 if b.y<0 or b.y>128 then
	 	del(bullets, b) end
	 	
	 for e in all(enemies) do
	 	if(coll(b,e)) then
	 		del(enemies,e)
	 		del(bullets,b)
	 		ship.p += 1
	 		explode(e.x,e.y)
	 	end
	 end
	end
	
	for e in all(enemies) do
		e.x = e.r*sin(t/50) + e.m_x
		e.y = e.r*cos(t/50) + e.m_y

		if coll(ship,e) and not ship.hit then
			ship.hit = true
			ship.hp -=1
			
			if ship.hp<=0 then
				game_over()
			end
		end
	
		
	end
	
	if btn(0) then ship.x-=1 end
	if btn(1) then ship.x+=1 end
	if btn(2) then ship.y-=1 end
	if btn(3) then ship.y+=1 end
	if btnp(4) then fire() end

end

function draw_game()
	cls()
	print(ship.hit)
	if not ship.hit or t%2 < 1 then
		spr(ship.sp,ship.x, ship.y)
	end

	for b in all(bullets) do
		spr(b.sp,b.x, b.y)
	end
	
	for e in all(enemies) do
		spr(e.sp,e.x,e.y)
	end
	
	for ex in all(explosions) do
		circ(ex.x, ex.y, ex.t/3, 8+ex.t)
		ex.t += 1
		if ex.t > 5 then
			del(explosions, ex)
		end
	end

	for i=1,4 do
		if i<=ship.hp then
			spr(33,80+6*i, 3)
		else
			spr(34,80+6*i, 3)
		end
	end	
end //draw_game

function draw_over()
	cls()
	print("game over", 50, 50, 5)
end
__gfx__
00000000000700000007000000000000900600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000760000007600000000000044640000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700006c6600006c660000007000004544400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700000666600006666000000a000044440040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000066566600665666000009000400404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070006575660065a566000000000900404090000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000660a00666609006600000000009004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000600900066008000600000000000009000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000900600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000045650000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000004544400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000044440040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000400404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000900404090000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000009004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000009000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000080800000d0d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000088888000ddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000088800000ddd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000080000000d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
0001000000000210501d050190501505014050316503165031650330503315032150311502f1502d1502a15028150261502415022150201301e1301d1301b13019120181201512012120101200f1100c1100b110
000200000b0700d0700e07024670246602465024650246502464022640256502564025630256302563024620226201e6201f6101f61020610206201f6101c6101961015610146101461014610136500e65008650
